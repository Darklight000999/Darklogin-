<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>darklight000999 | Home</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0f1220;
    --card:#14182a;
    --muted:#8ea0b5;
    --text:#eaf2ff;
    --brand:#6dd5ed;
    --brand2:#2193b0;
    --accent:#8a7dff;
    --danger:#ff5757;
    --success:#1ecb84;
    --glass:rgba(255,255,255,.06);
    --glass-strong:rgba(255,255,255,.12);
    --shadow: 0 10px 30px rgba(0,0,0,.45);
    --radius:14px;

    /* Sidebar palette */
    --sb-grad-left: #ff2a7a;
    --sb-grad-mid: #a24cff;
    --sb-grad-right:#1677ff;
    --sb-item-bg: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Poppins',sans-serif;color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, #1b2040 0, transparent 60%),
      radial-gradient(900px 600px at 110% 10%, #0a4250 0, transparent 60%),
      linear-gradient(180deg, #0a0e1a, #0b1020);
    overflow:hidden;
  }
  body::before{
    content:"";position:fixed;inset:-20%;z-index:-1;
    background: conic-gradient(from 180deg, #1c2760, #0f2346, #0c3d5a, #10253d, #1c2760);
    filter: blur(140px) saturate(120%); opacity:.22; animation: drift 30s linear infinite;
  }
  @keyframes drift{ to{ transform: rotate(1turn);} }

  .app{display:flex;height:100%;min-width:0}

/* ---------------- SIDEBAR (SLIM) ---------------- */
  .sidebar{
    width:220px;            /* slim width */
    min-width:200px;        /* mobile-safe */
    padding:14px 12px;
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
    border-right:1px solid rgba(255,255,255,.03);
    box-shadow: 0 20px 50px rgba(0,0,0,.55);
    overflow:auto; position:relative;
  }
  .sidebar::after{
    content:"";position:absolute;right:0;top:0;bottom:0;width:6px;
    background:linear-gradient(180deg, rgba(23,120,160,0.08), rgba(110,20,140,0.06));
    border-top-left-radius:8px;border-bottom-left-radius:8px;pointer-events:none;
  }

  .brandbar{display:flex;align-items:center;gap:8px;margin-bottom:12px}
  .brand-logo{width:40px;height:40px;border-radius:50%;object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,.6)}
  .brandname{font-weight:700;letter-spacing:.3px;font-size:15px}
  .theme-toggle{margin-left:auto;border:none;border-radius:999px;padding:6px 10px;cursor:pointer;
    background:linear-gradient(90deg,var(--brand2),var(--brand));color:#001018;font-weight:700;font-size:13px}
  .logo-box{display:flex;justify-content:center;margin:8px 0 8px}
  .logo-img{width:72px;height:72px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.06);
    box-shadow: 0 12px 30px rgba(24,40,70,.6);
  }

  nav.menu ul{list-style:none;margin:0;padding:0}
  nav.menu li{
    position:relative;
    display:flex;align-items:center;justify-content:flex-start;gap:10px;
    padding:12px 14px;margin:12px 4px;border-radius:16px;cursor:pointer;
    background: linear-gradient(180deg, rgba(10,14,20,.6), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,.02);
    box-shadow: inset 0 -4px 10px rgba(0,0,0,.45), 0 8px 20px rgba(0,0,0,.45);
    transition: transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s, background .18s;
    color:var(--text); font-size:17px; font-weight:600; overflow:visible;
  }
  nav.menu li .left{display:flex;align-items:center;gap:10px;min-width:0}
  nav.menu li .left span{white-space:nowrap; display:inline-block}
  nav.menu li .ico{font-size:20px; margin-right:4px}

  nav.menu li:hover{
    transform:translateY(-3px);
    box-shadow: 0 14px 36px rgba(24,48,80,.45);
  }

  nav.menu li.menu-active{
    background: linear-gradient(90deg, var(--sb-grad-left), var(--sb-grad-mid), var(--sb-grad-right));
    color:#fff; transform: translateY(-4px);
    box-shadow: 0 18px 46px rgba(120,60,200,.18);
  }
  nav.menu li.menu-active::before{
    content:"";position:absolute;inset:-6px;border-radius:18px;background:linear-gradient(90deg, rgba(255,42,122,0.08), rgba(162,76,255,0.08), rgba(22,119,255,0.08));filter:blur(8px);z-index:-1;
  }

  .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.06);color:var(--text);margin-left:auto;font-weight:700}
  .menu-active .badge{background:rgba(255,255,255,.9);color:#001018}

  .section-title{font-size:12px;opacity:.8;margin:8px 2px 6px;padding-left:6px}
  .sidebar-bottom{margin-top:12px}
  .logout{width:100%;padding:10px;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(90deg,#f56,#d33);color:white;font-weight:700;}

  /* Main */
  .main{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-bottom:1px solid rgba(255,255,255,.03);backdrop-filter: blur(6px);}
  .menu-btn{display:none}
  .brand-inline{display:flex;align-items:center;gap:10px;font-weight:700}
  .welcome{margin-left:auto;opacity:.9}

  .content{flex:1;overflow:auto;padding:18px;display:block}
  .section{display:none;animation:fade .25s ease}
  .section.active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .card{background:var(--glass);border:1px solid rgba(255,255,255,.04);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .muted{color:var(--muted)}
  .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--brand2),var(--brand));color:#001018}
  .btn-secondary{background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.08)}
  .row{display:flex;gap:10px;flex-wrap:wrap}

  .embed-wrap{position:relative;border-radius:var(--radius);overflow:hidden;background:#000;border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow)}
  .embed-wrap.ratio-16x9{padding-top:56.25%}
  .embed-wrap > iframe, .embed-wrap > div.embed-guard{position:absolute;inset:0;width:100%;height:100%;border:0}
  .embed-guard{pointer-events:none;background:transparent}

  .chat{display:flex;flex-direction:column;height:60vh;background:var(--glass);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden}
  .chat-head{padding:10px 14px;background:rgba(255,255,255,.04);font-weight:700}
  .chat-body{flex:1;overflow:auto;padding:12px}
  .msg{max-width:70%;margin:8px 0;padding:10px 12px;border-radius:14px;box-shadow:var(--shadow)}
  .me{margin-left:auto;background:linear-gradient(90deg,var(--brand2),var(--brand));color:#001018}
  .other{background:rgba(255,255,255,.08)}
  .meta{font-size:11px;opacity:.8;margin-bottom:4px}
  .chat-send{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.08)}
  .chat-send input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--text)}

  .form-row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .form-row input, .form-row select, .form-row textarea{flex:1;min-width:220px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text)}
  textarea{min-height:90px;resize:vertical}

  .overlay{display:none}
  .overlay.show{display:block;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:90}

  .blocker, .warn{position:fixed;inset:0;background:rgba(10,14,20,.9);color:#fff;display:none;place-items:center;z-index:9999;padding:20px;text-align:center}
  .blocker.show, .warn.show{display:grid}
  .warn .card{max-width:520px}

  img, video{ -webkit-user-drag:none; user-select:none }
  body{ -webkit-user-select:none; -ms-user-select:none; user-select:none }
  body.disable-select *{ user-select:none !important }

  @media (max-width: 900px){
    .menu-btn{display:inline-flex;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px}
    .sidebar{position:fixed;left:-100%;top:0;bottom:0;z-index:100}
    .sidebar.active{left:0}
  }

</style>
</head>
<body oncontextmenu="return false;">
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brandbar">
      <img class="brand-logo" src="1000058324.png" alt="logo" onerror="this.src='https://via.placeholder.com/80x80?text=DL'">
      <div class="brandname">darklight000999</div>
      <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">🌑 Dark</button>
    </div>

    <div class="logo-box">
      <img class="logo-img" src="1000058324.png" alt="Logo" onerror="this.src='https://via.placeholder.com/80x80?text=DL'">
    </div>

    <nav class="menu" aria-label="Main menu">
      <div class="section-title">Menu</div>
      <ul id="menu-items">
        <li data-target="home" onclick="onNav(this)"><div class="left"><span class="ico">🏠</span><span>Dashboard</span></div><span class="badge" id="count-home">1</span></li>
        <li data-target="chat" onclick="onNav(this)"><div class="left"><span class="ico">💬</span><span>Chat</span></div><span class="badge" id="count-chat">0</span></li>

        <!-- Admin-only items: hidden by default; shown by JS only for admin email -->
        <li id="menu-upload" data-target="upload" style="display:none" onclick="onNav(this)"><div class="left"><span class="ico">📂</span><span>Upload Manager</span></div><span class="badge" id="count-upload">—</span></li>
        <li id="menu-analytics" data-target="analytics" style="display:none" onclick="onNav(this)"><div class="left"><span class="ico">📊</span><span>Analytics</span></div><span class="badge" id="count-analytics">0</span></li>
        <li id="menu-settings" data-target="settings" style="display:none" onclick="onNav(this)"><div class="left"><span class="ico">⚙️</span><span>Settings</span></div><span class="badge" id="count-settings">—</span></li>

        <li data-target="announce" onclick="onNav(this)"><div class="left"><span class="ico">📢</span><span>Announcements</span></div><span class="badge" id="count-announce">0</span></li>
        <li data-target="support" onclick="onNav(this)"><div class="left"><span class="ico">🛠️</span><span>Support</span></div><span class="badge" id="count-support">1</span></li>
      </ul>

      <div class="section-title">Admin Panel</div>
      <ul id="admin-items" style="display:none">
        <li data-target="premium" onclick="onNav(this)"><div class="left"><span class="ico">👑</span><span>Premium Plus</span></div></li>
      </ul>
    </nav>

    <div class="sidebar-bottom">
      <button class="logout" onclick="logout()">🚪 Logout</button>
    </div>
  </aside>

  <!-- Overlay (mobile) -->
  <div id="overlay" class="overlay" onclick="toggleSidebar(false)"></div>

  <!-- Main -->
  <main class="main" id="main">
    <div class="topbar">
      <button class="menu-btn" onclick="toggleSidebar(true)">☰</button>
      <div class="brand-inline"><span>darklight000999</span></div>
      <span class="welcome" id="welcome">Welcome Guest</span>
    </div>

    <div class="content">

      <!-- HOME -->
      <section id="home" class="section active">
        <h2>🏠 Home</h2>
        <p class="muted">आपका Blogger पेज सीधे अंदर दिख रहा है (पूरा स्क्रॉल कर सकते हैं)।</p>

        <div class="embed-wrap" id="homeEmbed" style="width:100%; height:70vh; border-radius:12px; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.4);">
          <iframe sandbox="allow-scripts allow-forms allow-same-origin"
                  referrerpolicy="no-referrer"
                  src="https://darklight000999new205.blogspot.com/2025/08/darklight000999.html"
                  style="width:100%; height:100%; border:none;"
                  allowfullscreen loading="lazy"></iframe>
          <div class="embed-guard"></div>
        </div>
      </section>

      <!-- YOUTUBE -->
      <section id="youtube" class="section">
        <h2>🎬 YouTube Videos</h2>
        <div class="grid">
          <div class="card">
            <h3>Official Playlist</h3>
            <div class="embed-wrap ratio-16x9">
              <iframe src="https://www.youtube.com/embed/videoseries?list=PL9reQPbLfmEXG7m6txArrDbusSm1blBlk"
                      title="YouTube playlist" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      referrerpolicy="no-referrer" allowfullscreen loading="lazy"></iframe>
              <div class="embed-guard"></div>
            </div>
          </div>

          <div class="card">
            <h3>Admin Uploads</h3>
            <div id="ytList" class="grid"></div>
          </div>
        </div>
      </section>

      <!-- NOTES -->
      <section id="notes" class="section">
        <h2>📑 PDF & Notes</h2>
        <p class="muted">यहाँ shared PDFs/Notes दिखेंगे — डाउनलोड, राइट-क्लिक, सेलेक्ट आदि disabled (best-effort).</p>
        <div id="notesList" class="grid"></div>
      </section>

      <!-- COMMANDS -->
      <section id="commands" class="section">
        <h2>🧰 Hacking Commands</h2>
        <div id="cmdList" class="grid"></div>
      </section>

      <!-- HACKING -->
      <section id="hacking" class="section">
        <h2>🧪 Hacking</h2>
        <p class="muted">Ethical hacking research, tools, references — Admin द्वारा add की गई सामग्री।</p>
        <div id="hackList" class="grid"></div>
      </section>

      <!-- LIVE -->
      <section id="live" class="section">
        <h2>🎥 Live Class</h2>
        <div id="liveWrap" class="grid"></div>
      </section>

      <!-- SUPPORT -->
      <section id="support" class="section">
        <h2>🆘 Contact & Support</h2>
        <div class="card">
          <p>🔗 <b>यहाँ Google Sites लिंक डालें (हिंदी):</b></p>
          <p class="muted">उदा: https://sites.google.com/your-site</p>
          <div id="supportEmbed" class="embed-wrap ratio-16x9" style="display:none">
            <iframe id="supportIframe" sandbox="allow-scripts allow-forms allow-same-origin" referrerpolicy="no-referrer"></iframe>
            <div class="embed-guard"></div>
          </div>
        </div>
      </section>

      <!-- CHAT -->
      <section id="chat" class="section">
        <h2>💬 Chat</h2>
        <div class="chat">
          <div class="chat-head">Class Chat</div>
          <div id="chatBody" class="chat-body"></div>
          <div class="chat-send">
            <input id="chatInput" placeholder="Type a message..." maxlength="500" />
            <button class="btn" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </section>

      <!-- UPLOAD (Admin Only) -->
      <section id="upload" class="section">
        <h2>📂 Upload Manager (Admin Only)</h2>
        <div class="card">
          <div class="form-row">
            <select id="upCategory">
              <option value="youtube">YouTube</option>
              <option value="notes">Notes</option>
              <option value="commands">Commands</option>
              <option value="hacking">Hacking</option>
              <option value="live">Live</option>
              <option value="support">Support</option>
            </select>
            <input id="upTitle" placeholder="Title" />
          </div>

          <div class="form-row">
            <!-- either URL or file -->
            <input id="upLink" placeholder="Link / URL (YouTube, external link) — optional if uploading file" />
            <input id="upFile" type="file" accept="image/*,video/*,application/pdf" />
          </div>

          <div class="form-row">
            <textarea id="upDesc" placeholder="Description (optional)"></textarea>
          </div>

          <div class="row">
            <button class="btn" onclick="uploadContent()">Upload</button>
            <button class="btn btn-secondary" onclick="refreshAll()">Refresh</button>
          </div>

          <p class="muted" style="margin-top:6px">
            ध्यान: फ़ाइल अपलोड करने के बाद उसे Firebase Storage में स्टोर किया जाएगा। डाउनलोड/डिलीट रोकने की सर्वोत्तम कोशिशें की गई हैं — पर ब्राउज़र-साइड से पूर्ण रोकना संभव नहीं। सुनिश्चित करें कि आपने Firebase Storage Rules कन्फ़िगर कर रखी हैं (नीचे comment में उदाहरण दिया गया है)।
          </p>
        </div>
      </section>

      <!-- PREMIUM -->
      <section id="premium" class="section">
        <h2>👑 Premium Plus 🏆</h2>
        <div class="card">
          <p class="muted">Premium content placeholder</p>
        </div>
      </section>

      <!-- ANNOUNCEMENTS -->
      <section id="announce" class="section">
        <h2>📢 Announcements (Admin)</h2>
        <div class="card">
          <div class="form-row">
            <input id="anTitle" placeholder="Title" />
            <input id="anMedia" placeholder="Image/Video URL (optional)" />
          </div>
          <div class="form-row">
            <textarea id="anDesc" placeholder="Description"></textarea>
          </div>
          <button class="btn" onclick="postAnnouncement()">Post Announcement</button>
        </div>
        <div id="anList" class="grid" style="margin-top:12px"></div>
      </section>

      <!-- ANALYTICS -->
      <section id="analytics" class="section">
        <h2>📊 Analytics</h2>
        <div class="card">
          <p class="muted">सभी Students की सूची — Admin अस्थायी रूप से Block/Unblock कर सकता है।</p>
          <div id="studentsList" class="grid"></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="section">
        <h2>⚙️ Settings</h2>
        <div class="card">
          <p class="muted">Settings content here...</p>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Blocked user overlay -->
<div id="blocker" class="blocker"><div>
  <h2>Access Restricted</h2>
  <p>आपका अकाउंट अस्थायी रूप से ब्लॉक है। कृपया एडमिन से संपर्क करें।</p>
  <button class="btn" onclick="logout()">Logout</button>
</div></div>

<!-- Warning overlay (visibility / devtools attempts) -->
<div id="warn" class="warn">
  <div class="card">
    <h3>सुरक्षा सूचना</h3>
    <p>कंटेन्ट की सुरक्षा हेतु राइट-क्लिक/सेलेक्शन/रिकॉर्डिंग निष्क्रिय करने का प्रयास किया गया है।</p>
    <button class="btn" onclick="document.getElementById('warn').classList.remove('show')">ठीक है</button>
  </div>
</div>

<!-- Firebase (Modular) with Storage -->
<script type="module">
  /* ---------------- Firebase Setup ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp,
    setDoc, doc, getDoc, updateDoc, where
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8Ydj__jisqUsU1NGTXruCGsTi7wmIw8o",
    authDomain: "elegant-moment-470412-h3.firebaseapp.com",
    projectId: "elegant-moment-470412-h3",
    storageBucket: "elegant-moment-470412-h3.firebasestorage.app",
    messagingSenderId: "948629350861",
    appId: "1:948629350861:web:5d9e141e3bce27dd657c84"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const ADMIN_EMAIL = "darklightrkshackers@gmail.com";
  let CURRENT_USER = null;

  /* ---------------- Auth Guard ---------------- */
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      // user not logged in -> redirect to login page (index.html is your login page)
      window.location.href = "index.html";
      return;
    }
    CURRENT_USER = user;
    document.getElementById("welcome").textContent = "Welcome " + (user.email || "User");

    // create/update student record
    const sref = doc(db, "students", user.uid);
    const snap = await getDoc(sref);
    if(!snap.exists()){
      await setDoc(sref, { uid:user.uid, email:user.email||"", blocked:false, createdAt: serverTimestamp() });
    } else {
      const data = snap.data();
      if(data.blocked){
        document.getElementById("blocker").classList.add("show");
      }
    }

    // show admin panel items only for admin email
    const isAdmin = (user.email === ADMIN_EMAIL);
    document.getElementById("menu-upload").style.display = isAdmin ? "flex" : "none";
    document.getElementById("menu-analytics").style.display = isAdmin ? "flex" : "none";
    document.getElementById("menu-settings").style.display = isAdmin ? "flex" : "none";
    document.getElementById("admin-items").style.display = isAdmin ? "block" : "none";

    // start listeners and initial rendering
    listenAnnouncements();
    listenChat();
    await refreshAll();

    // highlight menu item according to active section
    highlightMenuForSection(document.querySelector('.section.active')?.id || 'home');
  });

  /* ---------------- UI Helpers ---------------- */
  window.toggleTheme = function(){
    const t = document.getElementById("themeBtn");
    if(t.textContent.includes("Dark")){ t.textContent="☀️ Light"; }
    else{ t.textContent="🌑 Dark"; }
    document.body.classList.toggle("disable-select");
    document.getElementById('warn').classList.add('show');
  };

  window.toggleSidebar = function(open){
    const sb=document.getElementById("sidebar");
    const ov=document.getElementById("overlay");
    if(open){ sb.classList.add("active"); ov.classList.add("show"); }
    else{ sb.classList.remove("active"); ov.classList.remove("show"); }
  };

  /* Sidebar selection visual */
  window.onNav = function(el){
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    const targetId = el.dataset.target;
    const targetEl = document.getElementById(targetId);
    if(targetEl) targetEl.classList.add("active");

    document.querySelectorAll("#menu-items li").forEach(li => li.classList.remove("menu-active"));
    el.classList.add("menu-active");

    toggleSidebar(false);
  };

  function highlightMenuForSection(sectionId){
    document.querySelectorAll("#menu-items li").forEach(li => {
      li.classList.toggle('menu-active', li.dataset.target === sectionId);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const first = document.querySelector('#menu-items li[data-target="home"]') || document.querySelector('#menu-items li');
    if(first){ first.classList.add('menu-active'); }
  });

  window.logout = function(){ signOut(auth).then(()=> window.location.href="index.html"); };

  /* ---------------- Content Store (Firestore + Storage) ----------------
     Collections used:
     - content {category, title, link, desc, createdAt, author, storagePath?}
     - announcements {title, desc, media, createdAt, author}
     - messages {uid, email, text, createdAt}
     - students {uid, email, blocked}
  ------------------------------------------------------------ */

  // Admin-only content add (handles file upload if present)
  async function addContent(category, title, link, desc, file){
    if(!CURRENT_USER || CURRENT_USER.email!==ADMIN_EMAIL) return alert("Admin only");
    if(!category || !title) return alert("कृपया जरूरी फ़ील्ड भरें");

    let finalLink = link || "";
    let storagePath = "";

    if(file){
      // upload to Firebase Storage under uploads/
      const ts = Date.now();
      const safeName = file.name.replace(/[^\w.\-]/g,'_');
      const path = `uploads/${ts}_${safeName}`;
      storagePath = path;
      const sRef = storageRef(storage, path);
      try{
        await new Promise((resolve, reject) => {
          const uploadTask = uploadBytesResumable(sRef, file);
          uploadTask.on('state_changed', null, (error) => reject(error), async () => {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            finalLink = url;
            resolve(url);
          });
        });
      }catch(err){
        console.error("Upload failed", err);
        return alert("Upload failed: " + (err.message || err));
      }
    }

    await addDoc(collection(db,"content"), {
      category, title, link: finalLink, desc: desc||"", createdAt: serverTimestamp(),
      author: CURRENT_USER.email, storagePath: storagePath || ""
    });
    alert("Uploaded");
    await refreshAll();
  }

  async function fetchContent(category){
    const q = query(collection(db,"content"), where("category","==",category), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    return snap.docs.map(d=>({id:d.id, ...d.data()}));
  }

  window.uploadContent = async function(){
    const cat = document.getElementById("upCategory").value.trim();
    const title = document.getElementById("upTitle").value.trim();
    const link = document.getElementById("upLink").value.trim();
    const desc = document.getElementById("upDesc").value.trim();
    const fileInput = document.getElementById("upFile");
    const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

    // If user tries to upload but is not admin block
    if(!CURRENT_USER || CURRENT_USER.email !== ADMIN_EMAIL) return alert("Admin only");

    if(!file && !link){
      return alert("कृपया या तो Link डालें या कोई फ़ाइल चुनें");
    }

    addContent(cat, title, link, desc, file);
    // clear file input after attempting upload
    setTimeout(()=>{ if(fileInput) fileInput.value=""; }, 200);
  };

  window.refreshAll = async function(){
    renderYT(await fetchContent("youtube"));
    renderNotes(await fetchContent("notes"));
    renderCommands(await fetchContent("commands"));
    renderHacking(await fetchContent("hacking"));
    renderLive(await fetchContent("live"));
    renderSupport(await fetchContent("support"));
    renderStudents(await getDocs(collection(db,"students")));
  };

  /* ---------------- Render functions (safe DOM creation) ---------------- */
  function renderYT(items){
    const wrap = document.getElementById("ytList");
    wrap.innerHTML="";
    items.forEach(x=>{
      const card = document.createElement("div"); card.className="card";
      const h4=document.createElement("h4"); h4.textContent = x.title || "Video";
      const embed=document.createElement("div"); embed.className="embed-wrap ratio-16x9";
      const ifr=document.createElement("iframe");
      const src = toYouTubeEmbed(x.link);
      ifr.setAttribute('loading','lazy'); ifr.setAttribute('referrerpolicy','no-referrer'); ifr.setAttribute('allowfullscreen','');
      if(src) ifr.src = src; else ifr.src = x.link || "";
      embed.appendChild(ifr);
      const g=document.createElement("div"); g.className="embed-guard"; embed.appendChild(g);
      card.appendChild(h4); card.appendChild(embed);
      if(x.desc){ const p=document.createElement("p"); p.className="muted"; p.textContent = x.desc; card.appendChild(p); }
      wrap.appendChild(card);
    });
    document.getElementById("count-youtube").textContent = String(items.length);
  }

  function renderNotes(items){
    const wrap = document.getElementById("notesList");
    wrap.innerHTML="";
    items.forEach(x=>{
      const card=document.createElement("div"); card.className="card";
      const h4=document.createElement("h4"); h4.textContent = x.title || "Note";
      const view = noteViewer(x.link);
      const embed=document.createElement("div"); embed.className="embed-wrap ratio-16x9";
      const ifr=document.createElement("iframe");
      ifr.setAttribute('sandbox','allow-scripts allow-same-origin'); ifr.setAttribute('referrerpolicy','no-referrer'); ifr.setAttribute('loading','lazy');
      ifr.src = view || x.link || "";
      embed.appendChild(ifr); embed.appendChild(document.createElement("div")).className="embed-guard";
      card.appendChild(h4); card.appendChild(embed);
      if(x.desc){ const p=document.createElement("p"); p.className="muted"; p.textContent=x.desc; card.appendChild(p); }
      wrap.appendChild(card);
    });
    document.getElementById("count-notes").textContent = String(items.length);
  }

  function renderCommands(items){
    const wrap = document.getElementById("cmdList");
    wrap.innerHTML="";
    items.forEach(x=>{
      const card=document.createElement("div"); card.className="card";
      const h4=document.createElement("h4"); h4.textContent = x.title || "Command";
      const pre=document.createElement("pre");
      pre.style.whiteSpace="pre-wrap"; pre.style.background="rgba(0,0,0,.25)"; pre.style.padding="10px";
      pre.style.borderRadius="12px"; pre.style.border="1px solid rgba(255,255,255,.12)";
      pre.textContent = x.desc || x.link || "";
      card.appendChild(h4); card.appendChild(pre);
      wrap.appendChild(card);
    });
    document.getElementById("count-commands").textContent = String(items.length);
  }

  function renderHacking(items){
    const wrap = document.getElementById("hackList");
    wrap.innerHTML="";
    items.forEach(x=>{
      const card=document.createElement("div"); card.className="card";
      const h4=document.createElement("h4"); h4.textContent = x.title || "Hacking";
      card.appendChild(h4);
      if(x.link){
        const a=document.createElement("a"); a.className="btn btn-secondary"; a.href=x.link; a.target="_blank"; a.rel="noopener noreferrer"; a.textContent="Open";
        card.appendChild(a);
      }
      if(x.desc){ const p=document.createElement("p"); p.className="muted"; p.style.marginTop="8px"; p.textContent = x.desc; card.appendChild(p); }
      wrap.appendChild(card);
    });
    document.getElementById("count-hacking").textContent = String(items.length);
  }

  function renderLive(items){
    const wrap = document.getElementById("liveWrap");
    wrap.innerHTML="";
    items.forEach(x=>{
      const card=document.createElement("div"); card.className="card";
      const h4=document.createElement("h4"); h4.textContent = x.title || "Live";
      const embed=document.createElement("div"); embed.className="embed-wrap ratio-16x9";
      const ifr=document.createElement("iframe"); ifr.setAttribute('loading','lazy'); ifr.setAttribute('allowfullscreen',''); ifr.setAttribute('referrerpolicy','no-referrer');
      ifr.src = toYouTubeEmbed(x.link) || x.link || "";
      embed.appendChild(ifr); embed.appendChild(document.createElement("div")).className="embed-guard";
      card.appendChild(h4); card.appendChild(embed);
      if(x.desc){ const p=document.createElement("p"); p.className="muted"; p.textContent = x.desc; card.appendChild(p); }
      wrap.appendChild(card);
    });
    document.getElementById("count-live").textContent = String(items.length);
  }

  function renderSupport(items){
    const latest = items[0];
    const wrap = document.getElementById("supportEmbed");
    const iframe = document.getElementById("supportIframe");
    if(latest && latest.link){
      iframe.src = latest.link;
      wrap.style.display = "block";
      document.getElementById("count-support").textContent = "1";
    } else {
      wrap.style.display = "none";
      document.getElementById("count-support").textContent = "0";
    }
  }

  /* ---------------- Announcements ---------------- */
  async function postAnnouncement(){
    if(!CURRENT_USER || CURRENT_USER.email!==ADMIN_EMAIL) return alert("Admin only");
    const title = document.getElementById("anTitle").value.trim();
    const desc  = document.getElementById("anDesc").value.trim();
    const media = document.getElementById("anMedia").value.trim();
    if(!title || !desc) return alert("Title और Description आवश्यक हैं");
    await addDoc(collection(db,"announcements"), {
      title, desc, media: media||"", createdAt: serverTimestamp(),
      author: CURRENT_USER.email
    });
    document.getElementById("anTitle").value="";
    document.getElementById("anDesc").value="";
    document.getElementById("anMedia").value="";
    alert("Announcement posted");
  }

  function listenAnnouncements(){
    const q = query(collection(db,"announcements"), orderBy("createdAt","desc"));
    onSnapshot(q, (snap)=>{
      const list = document.getElementById("anList");
      list.innerHTML="";
      snap.forEach(docu=>{
        const a = docu.data();
        const card = document.createElement("div"); card.className="card";
        const h3=document.createElement("h3"); h3.textContent = a.title; card.appendChild(h3);
        if(a.media){ const wrapper=document.createElement('div'); wrapper.innerHTML = mediaEmbed(a.media); card.appendChild(wrapper); }
        const p=document.createElement("p"); p.textContent = a.desc; card.appendChild(p);
        const meta=document.createElement("p"); meta.className="muted"; meta.textContent = "by " + (a.author||"Admin"); card.appendChild(meta);
        list.appendChild(card);
      });
    });
  }

  function mediaEmbed(url){
    const yt = toYouTubeEmbed(url);
    if(yt){
      return `<div class="embed-wrap ratio-16x9"><iframe src="${yt}" allowfullscreen loading="lazy"></iframe><div class="embed-guard"></div></div>`;
    }
    if(/\.(png|jpg|jpeg|gif|webp)$/i.test(url)){
      return `<img src="${url}" alt="media" style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.12)" />`;
    }
    if(/\.(mp4|webm|ogg)$/i.test(url)){
      return `<video src="${url}" controls style="width:100%;border-radius:12px"></video>`;
    }
    return `<a class="btn btn-secondary" href="${url}" target="_blank" rel="noopener">Open Link</a>`;
  }

  /* ---------------- Chat ---------------- */
  function listenChat(){
    const q = query(collection(db,"messages"), orderBy("createdAt","asc"));
    onSnapshot(q, (snap)=>{
      const body = document.getElementById("chatBody");
      body.innerHTML="";
      snap.forEach(d=>{
        const m = d.data();
        const mine = (CURRENT_USER && m.uid===CURRENT_USER.uid);
        const div = document.createElement("div");
        div.className = "msg " + (mine?"me":"other");
        const time = m.createdAt?.toDate ? m.createdAt.toDate() : new Date();
        const meta=document.createElement("div"); meta.className="meta"; meta.textContent = (m.email||"User") + " • " + formatTime(time);
        const txt=document.createElement("div"); txt.textContent = m.text||"";
        div.appendChild(meta); div.appendChild(txt);
        body.appendChild(div);
      });
      body.scrollTop = body.scrollHeight;
    });
  }

  window.sendMessage = async function(){
    const box = document.getElementById("chatInput");
    const txt = box.value.trim();
    if(!txt || !CURRENT_USER) return;
    await addDoc(collection(db,"messages"), {
      uid: CURRENT_USER.uid,
      email: CURRENT_USER.email || "User",
      text: txt,
      createdAt: serverTimestamp()
    });
    box.value="";
  };

  /* ---------------- Analytics: Students ---------------- */
  function renderStudents(snap){
    const grid = document.getElementById("studentsList");
    grid.innerHTML="";
    snap.forEach(docu=>{
      const s = docu.data();
      const card = document.createElement("div"); card.className="card";
      const h4=document.createElement("h4"); h4.textContent = s.email||"Unknown";
      const p1=document.createElement("p"); p1.className="muted"; p1.textContent = "UID: " + (s.uid||docu.id);
      const p2=document.createElement("p"); p2.innerHTML = 'Status: ' + (s.blocked?'<span style="color:var(--danger)">Blocked</span>':'<span style="color:var(--success)">Active</span>');
      card.appendChild(h4); card.appendChild(p1); card.appendChild(p2);
      if(CURRENT_USER && CURRENT_USER.email===ADMIN_EMAIL){
        const row=document.createElement("div"); row.className="row";
        const btn=document.createElement("button"); btn.className="btn btn-secondary"; btn.textContent = s.blocked?'Unblock':'Block';
        btn.onclick = ()=> toggleBlock(docu.id, !!s.blocked);
        row.appendChild(btn);
        card.appendChild(row);
      }
      grid.appendChild(card);
    });
  }

  window.toggleBlock = async function(uid, currentlyBlocked){
    if(!CURRENT_USER || CURRENT_USER.email!==ADMIN_EMAIL) return;
    await updateDoc(doc(db,"students",uid), { blocked: !currentlyBlocked });
    if(uid===CURRENT_USER.uid && !currentlyBlocked){
      document.getElementById("blocker").classList.add("show");
    }
  };

  /* ---------------- Small Utils ---------------- */
  function escapeHtml(str=""){ return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s])); }
  function toYouTubeEmbed(url=""){ try{ const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|live\/|shorts\/|embed\/|playlist\?list=|.*[?&]v=))([A-Za-z0-9_\-]{6,})/i); const list = url.match(/[?&]list=([A-Za-z0-9_\-]+)/i); if(list && url.includes("playlist")) return `https://www.youtube.com/embed/videoseries?list=${list[1]}`; if(m) return `https://www.youtube.com/embed/${m[1]}`; return url.includes("youtube.com/embed")?url:""; }catch(e){ return ""; } }
  function noteViewer(url=""){ if(/\.pdf(\?|$)/i.test(url)) return `https://drive.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(url)}`; return url; }
  function formatTime(d){ const t=new Date(d); return t.toLocaleString(); }

  // No-screenshot attempts
  document.addEventListener('keydown', (e)=>{ if(e.key==="PrintScreen" || (e.ctrlKey && e.key.toLowerCase()==="p")){ e.preventDefault(); document.getElementById('warn').classList.add('show'); } });
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ document.getElementById('warn').classList.add('show'); } });

  window.postAnnouncement = postAnnouncement;

  // initial count placeholders
  document.getElementById("count-home").textContent = "1";
  document.getElementById("count-chat").textContent = "0";
  document.getElementById("count-support").textContent = "1";

</script>

<!--
  IMPORTANT: Firebase Storage & Firestore Security Rules (deploy these in your Firebase console)
  --------------------------------------------------------------------------
  // Firestore (example)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isAdmin() {
        return request.auth != null && request.auth.token.email == 'darklightrkshackers@gmail.com';
      }
      match /students/{uid} {
        allow read: if request.auth != null;
        allow write: if isAdmin() || (request.auth != null && request.auth.uid == uid);
      }
      match /messages/{doc} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if false;
      }
      match /content/{doc} {
        allow read: if request.auth != null;
        allow create: if isAdmin();
        allow update, delete: if isAdmin(); // restrict edits/deletes to admin only
      }
      match /announcements/{doc} {
        allow read: if request.auth != null;
        allow create, update, delete: if isAdmin();
      }
    }
  }

  // Storage rules (example)
  service firebase.storage {
    match /b/{bucket}/o {
      // Allow read only for authenticated users via Firebase SDK (no public unauthenticated downloads)
      match /uploads/{allPaths=**} {
        allow read: if request.auth != null; // require auth to read file
        allow write: if request.auth != null && request.auth.token.email == 'darklightrkshackers@gmail.com'; // only admin can upload
        allow delete: if request.auth != null && request.auth.token.email == 'darklightrkshackers@gmail.com'; // you may restrict delete as needed (recommended: only admin)
      }
    }
  }

  NOTES:
  - Storage rules above require authentication to read the file; this prevents unauthenticated direct download links.
  - However, if you give a direct download URL (getDownloadURL), it can be used by anyone with that URL until revoked. To avoid public downloads:
    1) Avoid exposing raw getDownloadURL to clients. Instead serve files through a secure server endpoint / Cloud Function that checks auth and streams the file.
    2) Or keep files in storage but serve through authenticated Firebase SDK only (e.g., using downloadTokens carefully).
  - For simplicity here we store getDownloadURL in Firestore so the web app can embed it — but to harden further, consider serving via secure function.
  --------------------------------------------------------------------------
-->
</body>
</html>
